---
title: "Conditional independence testing using the ghcm package"
author: "Anton Rask Lundborg, Rajen D. Shah & Jonas Peters"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
description: >
  This vignette describes the practical usage of the ghcm package. For further 
  details on the theory behind the method, see the main reference paper.
vignette: >
  %\VignetteIndexEntry{Conditional independence testing using the ghcm package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(ghcm)
```

# Introduction


Note that ALL of the following relies on the precision of the regression methods used. We will not justify the use of the regression methods here but in all applications you should ensure that the regression methods work well.


Describe data.

```{r}
data("sugar_process")
```


# Real X, Y, Functional Z

Do test
```{r}
library(refund)

emission_wavelengths <- seq(275, 560, 0.5)

m_ash <- pfr(ash ~ lf(excitation_230, argvals=emission_wavelengths),
             data=sugar_process)
m_color <- pfr(color ~ lf(excitation_230, argvals=emission_wavelengths),
             data=sugar_process)

ghcm_test(resid(m_ash), resid(m_color), X_is_multivariate = TRUE, Y_is_multivariate = TRUE)
```
Compare with gcm

```{r}
library(GeneralisedCovarianceMeasure)
gcm.test(X=sugar_process$ash, Y=sugar_process$color,
         Z=sugar_process$excitation_230, resid.XonZ = resid(m_ash),
         resid.YonZ = resid(m_color))
```

We could also do the test given all the spectra.

```{r}
m_ash_full <- pfr(ash ~ lf(excitation_230, argvals=emission_wavelengths) +
                    lf(excitation_240, argvals=emission_wavelengths) +
                    lf(excitation_255, argvals=emission_wavelengths) +
                    lf(excitation_290, argvals=emission_wavelengths) +
                    lf(excitation_305, argvals=emission_wavelengths) +
                    lf(excitation_325, argvals=emission_wavelengths) +
                    lf(excitation_340, argvals=emission_wavelengths),
             data=sugar_process)
m_color_full <- pfr(color ~ lf(excitation_230, argvals=emission_wavelengths) +
                    lf(excitation_240, argvals=emission_wavelengths) +
                    lf(excitation_255, argvals=emission_wavelengths) +
                    lf(excitation_290, argvals=emission_wavelengths) +
                    lf(excitation_305, argvals=emission_wavelengths) +
                    lf(excitation_325, argvals=emission_wavelengths) +
                    lf(excitation_340, argvals=emission_wavelengths),
             data=sugar_process)

ghcm_test(resid(m_ash_full), resid(m_color_full))
```


Test color independent from ash given excitation (do a single and all)

# Real X, Function Y, Z

Test ash independent from excitation x given (single and rest)

# Multivariate X, Function Y, Z


# Functional X, Y, Z

Test excitation pairs independent given (single and rest)


