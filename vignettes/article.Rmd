---
documentclass: jss
classoption: [codesnippet, nojss]
author:
  - name: Anton Rask Lundborg
    affiliation: University of Cambridge
    # use this syntax to add text on several lines
    address: |
      | Statistical Laboratory
      | Department of Pure Mathematics and Mathematical Statistics
      | University of Cambridge
      | Center for Mathematical Sciences
      | Wilberforce Road
      | Cambridge, CB3 0WB
    email: \email{a.lundborg@statslab.cam.ac.uk}
    url: https://www.statslab.cam.ac.uk/~arlh2/
  - name: Rajen  D. Shah
    affiliation: University of Cambridge
  - name: Jonas Peters
    affiliation: University of Copenhagen
title:
  formatted: "Conditional Independence Testing for Functional Data in \\proglang{R} with \\pkg{ghcm}"
  # If you use tex in the formatted title, also supply version without
  plain:     "Conditional Independence Testing for Functional Data in R with ghcm"
  # For running headers, if needed
  short:     "Conditional Independence Testing with \\pkg{ghcm}"
abstract: >
  1
keywords:
  formatted: [conditional independence testing, functional data, "\\proglang{R}"]
  plain:     [conditional independence testing, functional data, R]
preamble: >
  \usepackage{amsmath}
  \usepackage{float}
  \newcommand{\Anton}[1]{{ \color{blue} Anton: #1}}
output: rticles::jss_article
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Conditional Independence Testing for Functional Data in \\proglang{R} with \\pkg{ghcm}}
  %\VignetteEncoding{UTF-8}
---

```{r, setup, include=FALSE}
options(prompt = 'R> ', continue = '+ ')
```



\section{Introduction} \label{sec:intro}




\section{The Generalised Hilbertian Covariance Measure (GHCM)} \label{sec:ghcm}



\section[Practical implementation in the ghcm package]{Practical implementation in the \pkg{ghcm} package}
\label{sec:practice}


\section{Example: analysing sugar process data}
\label{sec:ex}

This section will illustrate the usage of the \pkg{ghcm} package through
a an analysis of real dataset that is included with the package.

\Anton{ Add regression validity comment. }

\subsection{Sugar process data}
A sugar plant in Scandinavia was continuously sampled in 8 hour shifts across
the three months to produce 268 samples. The sugar was dissolved in water and
emission intensities between 275 and 560nm were measured at 0.5nm steps when the
sugar excited at seven different wavelengths (230, 240, 255, 290, 305, 325 and
340nm). Ash content of the sugar was measured by conductivity in percent and the
color of the sugar was determined on a scale where 45 is the maximum allowed
value for standard sugar. For additional details, see \citet{Bro1999}. The ash
content and color of the sugar are markers of the quality of the sugar and we
will try to elucidate the relationship between the quality of the sugar and the
emission spectra at the various excitation wavelengths. We can load the data by
calling \code{data(sugar_process)}. We also set the seed to ensure
reproducibility of the upcoming analysis and define a vector \code{emission_wavelengths} containing the emission wavelengths.
```{r}
library(ghcm)
set.seed(111)
data(sugar_process)
emission_wavelengths <- seq(275, 560, by=0.5)
colnames(sugar_process)
```
\code{sugar_process} consists of 268 color and ash measurements and 7 $268
\times 571$ matrices containing the emission intensities at the 7 different
excitation wavelengths. To illustrate the distribution of the emission spectra,
we plot the curves and the mean curve for the 230 and 305nm excitation wavelengths in Figure \ref{fig:wavelengths} using the code seen below.
```{r viz, fig.cap="\\label{fig:wavelengths} Plot of emission spectra from the sugar process data at excitation wavelengths 230 and 305nm."}
par(mfrow=c(1, 2))

matplot(emission_wavelengths, t(sugar_process$excitation_230), type="l",
        col=rgb(0,0,0,0.1) , lty=1, xlab="Emission wavelength",
        ylab="Intensity")
lines(emission_wavelengths, colMeans(sugar_process$excitation_230), col=2,
      lty=2, lwd=2)
title("230nm excitation")

matplot(emission_wavelengths, t(sugar_process$excitation_305), type="l",
        col=rgb(0,0,0,0.1) , lty=1, xlab="Emission wavelength",
        ylab="Intensity")
lines(emission_wavelengths, colMeans(sugar_process$excitation_305), col=2,
      lty=2, lwd=2)
title("305nm excitation")

par(mfrow=c(1, 1))
```

\Anton{Find a better title.}
\subsection{Testing conditional independence of scalars given functions }
Using the \pkg{ghcm} package, we will first test whether the ash content and the color of the sugar is independent given the all 7 emission spectra. Intuitively, this would represent the hypothesis that the color contains no information about the ash content, given the emission spectra (or vice versa). If we were interested in the ash content, we could then omit the color measurements from our modelling of the ash content and perhaps save time or resources by not measuring the color of the sugar.

To perform the conditional independence test, we need a scalar-on-function regression method and we will use the \code{pfr} function from the \pkg{refund} package with \code{lf}-terms.  \Anton{Cite package and method}. We will not justify the performance of the regression estimator here but, of course, the validity of the conditional independence test is tied to the convergence properties of the chosen regression method.
```{r}
library(refund)
m_ash <- pfr(ash ~ lf(excitation_230) + lf(excitation_240) +
               lf(excitation_255) + lf(excitation_290) +
               lf(excitation_305) + lf(excitation_325) +
               lf(excitation_340) , data=sugar_process)
m_color <- pfr(color ~ lf(excitation_230) + lf(excitation_240) +
                 lf(excitation_255) + lf(excitation_290) +
                 lf(excitation_305) + lf(excitation_325) +
                 lf(excitation_340) , data=sugar_process)
test <- ghcm_test(resid(m_ash), resid(m_color), X_grid = NA, Y_grid = NA )
print(test)
```
Since neither the ash content of the color are functional random variables, we set \code{X_grid} and \code{Y_grid} to be \code{NA}. This tells the \code{ghcm.test} function to treat the variables as real-valued observations rather than functional observations. We get a $p$-value of 0.0386 and an estimate of the test statistic of 10.7443. It should be noted that since the asymptotic distribution of the test statistic depends on the underlying distribution, there is no way to know the $p$-value from just the test statistic alone. However, we can get an idea of how extreme the test statistic is by plotting the asymptotic distribution and the test statistic together. This can be done by simply calling \code{plot} on the \code{ghcm} object, in this case \code{plot(test)}, which results in the plot seen in Figure \ref{fig:ash-color-asymptotic-dist}.
```{r test-plot1, echo=FALSE, fig.cap="\\label{fig:ash-color-asymptotic-dist} \\Anton{Add caption}"}
plot(test)
```


\Anton{Better title}
\subsection{Finding the Markov blanket}



\section{Summary and discussion} \label{sec:summary}



\section*{Acknowledgments}


\bibliography{refs}


\newpage

\begin{appendix}

\section{More technical details} \label{app:technical}

\end{appendix}


